<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ××¢×§×‘ ×›×•×—×•×ª - DEADZONE SAVER</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body { height: 100%; width: 100%; overflow: hidden; background: #1a1a1a; font-family: Arial, sans-serif; }

        #container { display: flex; height: 100vh; width: 100vw; flex-direction: row-reverse; }

        #map { flex-grow: 1; height: 100%; background: #2c3e50; position: relative; z-index: 1; }

        #sidebar { width: 300px; height: 100%; background: #2c3e50; color: white; padding: 20px; overflow-y: auto; z-index: 2; box-shadow: -2px 0 10px rgba(0,0,0,0.3); }

        /* ×”×ª×××” ×œ××•×‘×™×™×œ */
        @media (max-width: 768px) {
            #container { flex-direction: column; }
            #map { height: 60vh; width: 100%; }
            #sidebar { width: 100%; height: 40vh; padding: 15px; }
            #location-bar { right: 0 !important; left: 0 !important; bottom: 40vh !important; font-size: 11px !important; }
        }

        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; display: flex; justify-content: center; align-items: center; color: white; font-size: 24px; z-index: 9999; }
        #loading.hidden { display: none; }

        .layer-header { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #34495e; border-radius: 5px; margin-bottom: 5px; cursor: pointer; min-height: 48px; transition: 0.3s; }
        .layer-header:hover { background: #3498db; }
        .layer-header.active { background: #27ae60; }

        .force-item { background: #2c3e50; padding: 8px 12px; margin: 5px 0; border-radius: 3px; border-left: 3px solid; font-size: 13px; cursor: pointer; }
        .force-list { margin-left: 15px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .force-list.expanded { max-height: 500px; overflow-y: auto; }

        .custom-icon { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4); font-size: 14px; }

        #location-bar { position: fixed; bottom: 0; left: 0; right: 300px; background: rgba(44, 62, 80, 0.95); color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 1000; }

        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); display: flex; justify-content: center; align-items: center; z-index: 10000; }
        #login-box { background: #2c3e50; padding: 30px; border-radius: 10px; width: 90%; max-width: 400px; text-align: center; }
        #login-box input { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 5px; background: #34495e; color: white; border: 1px solid #3498db; }

        .btn-primary { background: #3498db; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; width: 100%; font-weight: bold; }
        .admin-only { display: none; }
        
        #add-force-modal, #add-deadzone-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #2c3e50; padding: 25px; border-radius: 10px; z-index: 10001; display: none; width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .modal-active { display: block !important; }

        #map-instruction { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #3498db; color: white; padding: 12px 25px; border-radius: 8px; z-index: 2000; display: none; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .selecting-mode { cursor: crosshair !important; }
    </style>
</head>
<body class="selecting-mode-disabled">
    <div id="login-overlay">
        <div id="login-box">
            <h2 style="color:white; margin-bottom:20px;">ğŸ›¡ï¸ DEADZONE SAVER</h2>
            <input type="text" id="username-input" placeholder="×©× ××©×ª××©" />
            <input type="password" id="password-input" placeholder="×¡×™×¡××”" />
            <button class="btn-primary" onclick="login()">×”×ª×—×‘×¨ ×œ××¢×¨×›×ª</button>
            <button onclick="viewAsGuest()" style="background:none; border:none; color:#bdc3c7; margin-top:15px; cursor:pointer; text-decoration:underline;">×›× ×™×¡×” ×œ×ª×¦×•×’×” ×‘×œ×‘×“</button>
        </div>
    </div>

    <div id="loading">â³ ×˜×•×¢×Ÿ ××¢×¨×›×•×ª ××¤×”...</div>
    
    <div id="container">
        <div id="map"></div>
        <div id="sidebar">
            <div id="status" style="padding:10px; text-align:center; border-radius:5px; margin-bottom:15px; font-weight:bold; background:#f39c12;">××ª×—×‘×¨ ×œ×©×¨×ª...</div>
            
            <div style="font-size:12px; margin-bottom:15px; background:#34495e; padding:8px; border-radius:5px;">
                ğŸ‘¤ ××©×ª××©: <span id="current-user">××•×¨×—</span>
            </div>

            <h3 style="margin-bottom:15px; border-bottom:2px solid #3498db; padding-bottom:5px;">×©×›×‘×•×ª ×›×•×—×•×ª</h3>
            <div id="layers"></div>
            
            <div class="admin-only" style="margin-top:20px; border-top:1px solid #455a64; pt:15px;">
                <button class="btn-primary" onclick="openAddForceModal()" style="margin-bottom:10px;">â• ×”×•×¡×£ ×›×•×— ×™×“× ×™</button>
                <button class="btn-primary" onclick="openAddDeadZoneModal()" style="background:#e67e22; margin-bottom:10px;">â˜¢ï¸ ×”×’×“×¨ Dead Zone</button>
                <button class="btn-primary" onclick="clearAllForces()" style="background:#c0392b;">ğŸ—‘ï¸ × ×§×” ××¤×”</button>
            </div>

            <div style="background:#34495e; padding:12px; border-radius:5px; margin-top:15px;">
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px;">
                    <input type="checkbox" id="show-predictions" checked onchange="togglePredictions()"> ğŸ”® ×—×™×–×•×™×™ ××¡×œ×•×œ (AI)
                </label>
            </div>

            <button id="logout-btn" style="display:none; margin-top:20px; background:#455a64;" class="btn-primary" onclick="logout()">×”×ª× ×ª×§</button>
        </div>
        
        <div id="location-bar">
            <div style="display:flex; gap:20px;">
                <div>ğŸ“ <span id="mouse-coords" style="font-family:monospace;">---, ---</span></div>
                <div id="location-name" style="opacity:0.8;">××–×”×” ××™×§×•×...</div>
            </div>
            <div>×–×•×: <span id="zoom-level">8</span></div>
        </div>
    </div>

    <div id="map-instruction"></div>

    <div id="add-force-modal">
        <h3 style="color:white; margin-bottom:15px;">â• ×”×•×¡×¤×ª ×›×•×— ×—×“×©</h3>
        <input type="text" id="force-name-input" placeholder="×©× ×”×›×•×— / ×™×—×™×“×”" style="width:100%; padding:12px; margin-bottom:10px; border-radius:5px; border:none;" />
        <select id="force-type-input" style="width:100%; padding:12px; margin-bottom:10px; border-radius:5px; background:#34495e; color:white; border:none;">
            <option value="infantry">×›×•×—×•×ª ×—×™"×¨</option>
            <option value="armor">×›×•×—×•×ª ×©×¨×™×•×Ÿ</option>
            <option value="artillery">××¨×˜×™×œ×¨×™×”</option>
            <option value="other">××—×¨</option>
        </select>
        <button class="btn-primary" onclick="selectLocationOnMap('force')" style="background:#16a085; margin-bottom:10px;">ğŸ“ ×“×§×•×¨ ××™×§×•× ×‘××¤×”</button>
        <div id="force-location-preview" style="color:#2ecc71; font-weight:bold; font-size:12px; margin-bottom:10px; display:none; text-align:center;">××™×§×•× × ×“×§×¨ ×‘×”×¦×œ×—×”!</div>
        <button class="btn-primary" onclick="submitForce()">××©×¨ ×•×”×•×¡×£</button>
        <button onclick="closeAddForceModal()" style="background:none; border:none; color:#bdc3c7; width:100%; margin-top:10px; cursor:pointer;">×‘×™×˜×•×œ</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script>
        // --- ×”×’×“×¨×•×ª ××¢×¨×›×ª ---
        const SERVER_URL = window.location.origin;
        let map, stompClient = null;
        let markers = {}, deadzones = {}, predictionLines = {};
        let isAdmin = false, isSelectingLocation = false, showPredictions = true;

        let layers = {
            'infantry': { name: '×—×™"×¨', color: '#e74c3c', visible: true, markers: [], icon: 'ğŸ‘¥', expanded: true },
            'armor': { name: '×©×¨×™×•×Ÿ', color: '#3498db', visible: true, markers: [], icon: 'ğŸ›¡ï¸', expanded: true },
            'artillery': { name: '××¨×˜×™×œ×¨×™×”', color: '#f39c12', visible: true, markers: [], icon: 'ğŸ’£', expanded: true },
            'other': { name: '×›×œ×œ×™', color: '#95a5a6', visible: true, markers: [], icon: 'ğŸ“¦', expanded: true },
            'deadzone': { name: '××–×•×¨×™ ×¡×›× ×”', color: '#ff0000', visible: true, markers: [], icon: 'â˜¢ï¸', expanded: true }
        };

        // --- ××ª×—×•×œ ××¤×” ---
        function initMap() {
            map = L.map('map', { center: [32.0853, 34.7818], zoom: 8, zoomControl: true });
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);

            setTimeout(() => { 
                map.invalidateSize(); 
                document.getElementById('loading').classList.add('hidden');
            }, 600);

            map.on('mousemove', e => {
                document.getElementById('mouse-coords').textContent = `${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
            });

            map.on('zoomend', () => document.getElementById('zoom-level').textContent = map.getZoom());
            
            window.onresize = () => map.invalidateSize();

            renderLayers();
            connectToServer();
            loadInitialData();
        }

        // --- ×ª×§×©×•×¨×ª Real-time ---
        function connectToServer() {
            const socket = new SockJS(SERVER_URL + '/ws');
            stompClient = Stomp.over(socket);
            stompClient.debug = null; // ×©×§×˜ ×‘×œ×•×’×™×

            stompClient.connect({}, () => {
                updateStatus('connected', '××—×•×‘×¨ ×‘×–××Ÿ ×××ª âœ“');
                
                stompClient.subscribe('/topic/locations', msg => {
                    const data = JSON.parse(msg.body);
                    processLocationUpdate(data);
                });

                stompClient.subscribe('/topic/deadzones', msg => {
                    const dz = JSON.parse(msg.body);
                    addDeadZoneToMap(dz);
                });
                
                stompClient.subscribe('/topic/removed', msg => removeForceFromMap(msg.body));
            }, () => {
                updateStatus('disconnected', '× ×™×ª×•×§ - ×× ×¡×” ×œ×”×ª×—×‘×¨... âš ï¸');
                setTimeout(connectToServer, 5000);
            });
        }

        function processLocationUpdate(data) {
            if (markers[data.id]) {
                markers[data.id].setLatLng([data.latitude, data.longitude]);
            } else {
                const layer = layers[data.type] || layers['other'];
                const icon = L.divIcon({
                    className: 'force-marker',
                    html: `<div class="custom-icon" style="background:${layer.color}">${layer.icon}</div>`,
                    iconSize: [30, 30]
                });
                const marker = L.marker([data.latitude, data.longitude], { icon }).addTo(map);
                marker.bindPopup(`<b>${data.name}</b><br>×¡×•×’: ${layer.name}`);
                markers[data.id] = marker;
                layer.markers.push(marker);
                if (!layer.visible) marker.remove();
            }
            if (showPredictions) fetchPrediction(data.id);
            renderLayers(); 
        }

        // --- × ×™×”×•×œ ×©×›×‘×•×ª ---
        function renderLayers() {
            const container = document.getElementById('layers');
            container.innerHTML = '';
            Object.entries(layers).forEach(([key, layer]) => {
                const el = document.createElement('div');
                el.innerHTML = `
                    <div class="layer-header ${layer.visible ? 'active' : ''}" onclick="toggleLayerVisibility('${key}')">
                        <span>${layer.icon} ${layer.name} (${layer.markers.length})</span>
                        <div style="width:12px; height:12px; border-radius:50%; background:${layer.color}"></div>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        function toggleLayerVisibility(key) {
            layers[key].visible = !layers[key].visible;
            layers[key].markers.forEach(m => layers[key].visible ? m.addTo(map) : m.remove());
            renderLayers();
        }

        // --- ××“××™×Ÿ ×•×ª×¤×¢×•×œ ---
        function login() {
            const u = document.getElementById('username-input').value;
            const p = document.getElementById('password-input').value;
            if (u === 'admin' && p === 'admin123') {
                isAdmin = true;
                document.getElementById('login-overlay').style.display = 'none';
                document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'block');
                document.getElementById('logout-btn').style.display = 'block';
                document.getElementById('current-user').textContent = '×× ×”×œ ××¢×¨×›×ª';
            } else { alert('×¤×¨×˜×™× ×©×’×•×™×™×'); }
        }

        function viewAsGuest() { document.getElementById('login-overlay').style.display = 'none'; }

        function selectLocationOnMap(type) {
            isSelectingLocation = true;
            document.getElementById('map-instruction').textContent = 'ğŸ“ ×“×§×•×¨ × ×§×•×“×” ×¢×œ ×”××¤×”...';
            document.getElementById('map-instruction').style.display = 'block';
            document.getElementById('add-force-modal').classList.remove('modal-active');
            
            map.once('click', e => {
                window.lastClickedPos = e.latlng;
                document.getElementById('force-location-preview').style.display = 'block';
                document.getElementById('map-instruction').style.display = 'none';
                document.getElementById('add-force-modal').classList.add('modal-active');
                isSelectingLocation = false;
            });
        }

        function submitForce() {
            const name = document.getElementById('force-name-input').value;
            if (!name || !window.lastClickedPos) return alert('×—×¡×¨×™× × ×ª×•× ×™×');
            
            fetch(SERVER_URL + '/api/forces/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id: 'manual_' + Date.now(),
                    name: name,
                    type: document.getElementById('force-type-input').value,
                    latitude: window.lastClickedPos.lat,
                    longitude: window.lastClickedPos.lng
                })
            }).then(() => closeAddForceModal());
        }

        // --- ×—×™×–×•×™ AI ---
        function fetchPrediction(id) {
            fetch(`${SERVER_URL}/api/trajectory/predict/${id}?seconds=60`)
                .then(r => r.ok ? r.json() : null)
                .then(data => {
                    if (data && data.predictedPath) drawPath(id, data.predictedPath);
                });
        }

        function drawPath(id, path) {
            if (predictionLines[id]) map.removeLayer(predictionLines[id]);
            const pts = path.map(p => [p.latitude, p.longitude]);
            predictionLines[id] = L.polyline(pts, { color: 'white', weight: 2, dashArray: '5, 10', opacity: 0.5 }).addTo(map);
        }

        function togglePredictions() {
            showPredictions = document.getElementById('show-predictions').checked;
            if (!showPredictions) Object.values(predictionLines).forEach(l => map.removeLayer(l));
        }

        function updateStatus(status, text) {
            const s = document.getElementById('status');
            s.className = status;
            s.textContent = text;
            s.style.background = status === 'connected' ? '#27ae60' : '#e74c3c';
        }

        function openAddForceModal() { document.getElementById('add-force-modal').classList.add('modal-active'); }
        function closeAddForceModal() { document.getElementById('add-force-modal').classList.remove('modal-active'); }

        window.onload = initMap;
    </script>
</body>
</html>