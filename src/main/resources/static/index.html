<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ××¢×§×‘ ×›×•×—×•×ª - ×¨×¡×¤×•× ×¡×™×‘×™×ª</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #1a1a1a;
        }

        /* ×§×•× ×˜×™×™× ×¨ ×¨××©×™ - ×‘×‘×¨×™×¨×ª ××—×“×œ ×œ××—×©×‘ */
        #container {
            display: flex;
            height: 100vh;
            flex-direction: row-reverse;
        }

        #map {
            flex: 1;
            height: 100%;
            background: #e0e0e0;
            position: relative;
            z-index: 1;
        }

        #sidebar {
            width: 300px;
            background: #2c3e50;
            color: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0,0,0,0.3);
            z-index: 2;
        }

        /* ×”×ª×××” ×œ××•×‘×™×™×œ ×•×˜××‘×œ×˜ */
        @media (max-width: 768px) {
            #container {
                flex-direction: column; /* ×¡×¨×’×œ ××ª×—×ª ×œ××¤×” */
            }
            #sidebar {
                width: 100%;
                height: 40vh; /* ×”×¡×¨×’×œ ×ª×•×¤×¡ 40% ××”×’×•×‘×” ×‘× ×™×™×“ */
                padding: 15px;
            }
            #location-bar {
                right: 0 !important;
                left: 0 !important;
                font-size: 11px !important;
            }
            #add-force-modal, #add-deadzone-modal {
                width: 95% !important;
                min-width: unset !important;
            }
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            z-index: 9999;
        }

        #loading.hidden { display: none; }

        h2 {
            margin-bottom: 20px;
            color: #ecf0f1;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .layer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #34495e;
            border-radius: 5px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 48px; /* × ×•×— ×œ×˜××¥' */
        }

        .layer-header:hover { background: #3498db; }
        .layer-header.active { background: #27ae60; }

        .layer-checkbox { width: 22px; height: 22px; cursor: pointer; }

        .layer-name { font-weight: bold; font-size: 16px; }

        .color-indicator {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid white;
        }

        #status {
            background: #27ae60;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }

        #status.disconnected { background: #e74c3c; }
        #status.connecting { background: #f39c12; }

        .force-marker { background: transparent; border: none; }

        .custom-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            font-size: 14px;
        }

        #location-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 300px;
            background: rgba(44, 62, 80, 0.95);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            font-size: 14px;
        }

        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        #login-overlay.hidden { display: none; }

        #login-box {
            background: #2c3e50;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            width: 90%;
            max-width: 400px;
        }

        #login-box input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 5px;
            background: #34495e;
            color: white;
            border: 1px solid #3498db;
        }

        #add-force-modal, #add-deadzone-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2c3e50;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 10001;
            display: none;
            min-width: 350px;
            max-height: 90vh;
            overflow-y: auto;
        }

        #add-force-modal.active, #add-deadzone-modal.active { display: block; }

        .force-list {
            margin-left: 10px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .force-list.expanded { max-height: 500px; overflow-y: auto; }

        .force-item {
            background: #2c3e50;
            padding: 10px;
            margin: 5px 0;
            border-radius: 3px;
            border-left: 4px solid;
            cursor: pointer;
        }

        .admin-only { display: none; }
        
        .btn-primary { background: #3498db; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; width: 100%; }
        
        #map-instruction {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(52, 152, 219, 0.95);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 2000;
            display: none;
        }

        .selecting-mode { cursor: crosshair !important; }
    </style>
</head>
<body>
    <div id="login-overlay">
        <div id="login-box">
            <h2>ğŸ” ×”×ª×—×‘×¨×•×ª ×œ××¢×¨×›×ª</h2>
            <input type="text" id="username-input" placeholder="×©× ××©×ª××©" />
            <input type="password" id="password-input" placeholder="×¡×™×¡××”" />
            <button class="btn-primary" onclick="login()">×”×ª×—×‘×¨</button>
            <button onclick="viewAsGuest()" style="background: #95a5a6; border:none; color:white; padding:10px; width:100%; margin-top:10px; border-radius:5px; cursor:pointer;">×›× ×™×¡×” ×›××•×¨×— (×¦×¤×™×™×” ×‘×œ×‘×“)</button>
            <div id="login-error" style="color: #e74c3c; margin-top:10px;"></div>
        </div>
    </div>

    <div id="loading">â³ ×˜×•×¢×Ÿ ××¤×”...</div>
    
    <div id="container" style="display: none;">
        <div id="map"></div>
        <div id="sidebar">
            <div id="error-message" style="display:none; background:#e74c3c; padding:10px; border-radius:5px; margin-bottom:10px;"></div>
            <div id="status" class="connecting">××ª×—×‘×¨ ×œ×©×¨×ª...</div>
            
            <div id="connection-info" style="font-size:12px; background:#34495e; padding:10px; border-radius:5px; margin-bottom:10px;">
                <div>××—×•×‘×¨: <span id="connected-status">×œ×</span></div>
                <div id="user-status">××©×ª××©: <span id="current-user">××•×¨×—</span></div>
            </div>

            <button id="logout-btn" style="display: none; background:#e74c3c; color:white; border:none; padding:8px; width:100%; border-radius:5px; margin-bottom:10px;" onclick="logout()">×”×ª× ×ª×§</button>
            
            <h2>×©×›×‘×•×ª ×›×•×—×•×ª</h2>
            <div id="layers"></div>
            
            <div id="test-buttons" class="admin-only" style="margin-top:10px;">
                <button class="btn-primary" onclick="openAddForceModal()" style="margin-bottom:5px;">â• ×”×•×¡×£ ×›×•×— ×™×“× ×™</button>
                <button class="btn-primary" onclick="openAddDeadZoneModal()" style="background:#e67e22; margin-bottom:5px;">â˜¢ï¸ ×”×•×¡×£ Dead Zone</button>
                <button class="btn-primary" onclick="clearAllForces()" style="background:#c0392b;">ğŸ—‘ï¸ × ×§×” ×”×›×œ</button>
            </div>
            
            <div class="prediction-controls" style="background:#34495e; padding:10px; border-radius:5px; margin-top:15px;">
                <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <input type="checkbox" id="show-predictions" checked onchange="togglePredictions()">
                    ğŸ”® ×”×¦×’ ×—×™×–×•×™×™ ××¡×œ×•×œ
                </label>
                <div style="margin-top:10px; font-size:12px;">
                    <label>×–××Ÿ ×—×™×–×•×™: <span id="prediction-time-label">60</span> ×©× ×™×•×ª</label>
                    <input type="range" id="prediction-time" min="30" max="300" value="60" step="30" style="width:100%" oninput="updatePredictionTime(this.value)">
                </div>
            </div>
        </div>
        
        <div id="location-bar">
            <div id="location-info" style="display:flex; gap:15px;">
                <div>ğŸ“ <span id="mouse-coords" style="font-family:monospace;">---, ---</span></div>
                <div id="location-name" style="max-width:150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">×˜×•×¢×Ÿ ××™×§×•×...</div>
            </div>
            <div>ğŸ—ºï¸ ×–×•×: <span id="zoom-level">8</span></div>
        </div>
    </div>

    <div id="map-instruction"></div>

    <div id="add-force-modal">
        <div style="font-size:18px; margin-bottom:15px; border-bottom:2px solid #3498db; padding-bottom:5px;">â• ×”×•×¡×¤×ª ×›×•×— ×—×“×©</div>
        <input type="text" id="force-name-input" placeholder="×©× ×”×›×•×—" style="width:100%; padding:10px; margin-bottom:10px; background:#34495e; color:white; border:none; border-radius:5px;" />
        <select id="force-type-input" style="width:100%; padding:10px; margin-bottom:10px; background:#34495e; color:white; border:none; border-radius:5px;">
            <option value="infantry">×—×™"×¨</option>
            <option value="armor">×©×¨×™×•×Ÿ</option>
            <option value="artillery">×ª×•×ª×—× ×™×</option>
            <option value="other">××—×¨</option>
        </select>
        <button class="btn-primary" onclick="selectLocationOnMap('force')" style="margin-bottom:10px;">ğŸ“ ×‘×—×¨ ××™×§×•× ×‘××¤×”</button>
        <div id="force-location-preview" style="display:none; font-size:12px; margin-bottom:10px;">× ×‘×—×¨: <span id="force-lat"></span>, <span id="force-lng"></span></div>
        <div style="display:flex; gap:5px;">
            <button class="btn-primary" onclick="submitForce()">××™×©×•×¨</button>
            <button class="btn-primary" style="background:#95a5a6;" onclick="closeAddForceModal()">×‘×™×˜×•×œ</button>
        </div>
    </div>

    <div id="add-deadzone-modal">
        <div style="font-size:18px; margin-bottom:15px; border-bottom:2px solid #e74c3c; padding-bottom:5px;">â˜¢ï¸ ×”×•×¡×¤×ª Dead Zone</div>
        <input type="text" id="deadzone-name-input" placeholder="×©× ×”××–×•×¨" style="width:100%; padding:10px; margin-bottom:10px; background:#34495e; color:white; border:none; border-radius:5px;" />
        <input type="number" id="deadzone-radius-input" value="2000" style="width:100%; padding:10px; margin-bottom:10px; background:#34495e; color:white; border:none; border-radius:5px;" />
        <button class="btn-primary" onclick="selectLocationOnMap('deadzone')" style="margin-bottom:10px;">ğŸ“ ×‘×—×¨ ××¨×›×– ×‘××¤×”</button>
        <div id="deadzone-location-preview" style="display:none; font-size:12px; margin-bottom:10px;">× ×‘×—×¨: <span id="deadzone-lat"></span>, <span id="deadzone-lng"></span></div>
        <div style="display:flex; gap:5px;">
            <button class="btn-primary" style="background:#e74c3c;" onclick="submitDeadZone()">×”×•×¡×£ ××–×•×¨</button>
            <button class="btn-primary" style="background:#95a5a6;" onclick="closeAddDeadZoneModal()">×‘×™×˜×•×œ</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script>
        // --- ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ---
        const SERVER_URL = window.location.origin;
        let map, stompClient = null;
        let markers = {}, deadzones = {}, predictionLines = {};
        let isAdmin = false, currentUser = 'guest', showPredictions = true;
        let isSelectingLocation = false, locationCallback = null;

        const ADMIN_CREDENTIALS = { username: 'admin', password: 'admin123' };
        let layers = {
            'infantry': { name: '×›×•×—×•×ª ×—×™"×¨', color: '#e74c3c', visible: true, markers: [], icon: 'ğŸ‘¥', expanded: true },
            'armor': { name: '×›×•×—×•×ª ×©×¨×™×•×Ÿ', color: '#3498db', visible: true, markers: [], icon: 'ğŸ›¡ï¸', expanded: true },
            'artillery': { name: '×ª×•×ª×—× ×™×', color: '#f39c12', visible: true, markers: [], icon: 'ğŸ’£', expanded: true },
            'other': { name: '××—×¨', color: '#95a5a6', visible: true, markers: [], icon: 'ğŸ“¦', expanded: true },
            'deadzone': { name: 'Dead Zones', color: '#ff0000', visible: true, markers: [], icon: 'â˜¢ï¸', expanded: true }
        };

        // --- ××ª×—×•×œ ××¤×” ---
        function initMap() {
            try {
                map = L.map('map', { center: [32.0853, 34.7818], zoom: 8 });
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OSM' }).addTo(map);
                
                map.on('mousemove', e => {
                    document.getElementById('mouse-coords').textContent = `${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
                    updateLocationName(e.latlng.lat, e.latlng.lng);
                });

                map.on('zoomend', () => document.getElementById('zoom-level').textContent = map.getZoom());
                
                window.addEventListener('resize', () => map.invalidateSize());

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('container').style.display = 'flex';
                
                renderLayers();
                connectToServer();
                loadExistingForces();
            } catch (e) { console.error("Map Error:", e); }
        }

        // --- ×—×™×‘×•×¨ ×œ×©×¨×ª ---
        function connectToServer() {
            fetch(SERVER_URL + '/api/forces/health').then(() => {
                const socket = new SockJS(SERVER_URL + '/ws');
                stompClient = Stomp.over(socket);
                stompClient.connect({}, frame => {
                    updateStatus('connected', '××—×•×‘×¨ âœ“');
                    document.getElementById('connected-status').textContent = '×›×Ÿ';
                    
                    stompClient.subscribe('/topic/locations', msg => {
                        const data = JSON.parse(msg.body);
                        addForce(data.id, data.latitude, data.longitude, data.type, data.name);
                    });
                    
                    stompClient.subscribe('/topic/deadzones', msg => {
                        const dz = JSON.parse(msg.body);
                        addDeadZone(dz.id, dz.latitude, dz.longitude, dz.radius, dz.name, dz.description);
                    });
                });
            }).catch(() => updateStatus('disconnected', '×©×¨×ª ×œ× ×–××™×Ÿ âš ï¸'));
        }

        function updateStatus(status, text) {
            const el = document.getElementById('status');
            el.textContent = text;
            el.className = status;
        }

        // --- × ×™×”×•×œ ×©×›×‘×•×ª ×•×›×•×—×•×ª ---
        function renderLayers() {
            const div = document.getElementById('layers');
            div.innerHTML = '';
            for (const [key, layer] of Object.entries(layers)) {
                const layerEl = document.createElement('div');
                layerEl.innerHTML = `
                    <div class="layer-header ${layer.visible ? 'active' : ''}" onclick="toggleLayerExpand('${key}')">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <input type="checkbox" class="layer-checkbox" ${layer.visible ? 'checked' : ''} onclick="event.stopPropagation(); toggleLayer('${key}')">
                            <span class="layer-name">${layer.icon} ${layer.name}</span>
                        </div>
                        <div class="color-indicator" style="background:${layer.color}"></div>
                    </div>
                    <div id="list-${key}" class="force-list ${layer.expanded ? 'expanded' : ''}"></div>
                `;
                div.appendChild(layerEl);
            }
        }

        function toggleLayer(key) {
            layers[key].visible = !layers[key].visible;
            layers[key].markers.forEach(m => layers[key].visible ? m.addTo(map) : m.remove());
            renderLayers();
        }

        function toggleLayerExpand(key) {
            layers[key].expanded = !layers[key].expanded;
            renderLayers();
        }

        function addForce(id, lat, lng, type, name) {
            if (markers[id]) {
                markers[id].setLatLng([lat, lng]);
            } else {
                const layer = layers[type] || layers['other'];
                const icon = L.divIcon({
                    className: 'force-marker',
                    html: `<div class="custom-icon" style="background:${layer.color}">${layer.icon}</div>`,
                    iconSize: [30, 30]
                });
                const marker = L.marker([lat, lng], { icon }).bindPopup(`<b>${name}</b>`);
                if (layer.visible) marker.addTo(map);
                markers[id] = marker;
                layer.markers.push(marker);
            }
            if (showPredictions) updatePrediction(id);
        }

        function addDeadZone(id, lat, lng, radius, name, description) {
            if (deadzones[id]) return;
            const circle = L.circle([lat, lng], { radius, color: 'red', fillOpacity: 0.2 }).addTo(map);
            circle.bindPopup(`<b>${name}</b><br>${description}`);
            deadzones[id] = circle;
        }

        // --- ×œ×•×’×™×§×ª ××“××™×Ÿ ×•×‘×—×™×¨×ª ××™×§×•× ---
        function login() {
            const u = document.getElementById('username-input').value;
            const p = document.getElementById('password-input').value;
            if (u === ADMIN_CREDENTIALS.username && p === ADMIN_CREDENTIALS.password) {
                isAdmin = true;
                document.getElementById('login-overlay').classList.add('hidden');
                document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'block');
                document.getElementById('logout-btn').style.display = 'block';
                document.getElementById('current-user').textContent = '×× ×”×œ';
            }
        }

        function viewAsGuest() {
            document.getElementById('login-overlay').classList.add('hidden');
        }

        function selectLocationOnMap(type) {
            isSelectingLocation = true;
            locationCallback = type;
            document.getElementById('map-instruction').textContent = 'ğŸ‘† ×‘×—×¨ ××™×§×•× ×‘××¤×”';
            document.getElementById('map-instruction').style.display = 'block';
            document.body.classList.add('selecting-mode');
            
            map.once('click', e => {
                const lat = e.latlng.lat, lng = e.latlng.lng;
                document.getElementById(type + '-lat').textContent = lat.toFixed(5);
                document.getElementById(type + '-lng').textContent = lng.toFixed(5);
                document.getElementById(type + '-location-preview').style.display = 'block';
                
                document.getElementById('map-instruction').style.display = 'none';
                document.body.classList.remove('selecting-mode');
                isSelectingLocation = false;
            });
        }

        function submitForce() {
            const name = document.getElementById('force-name-input').value;
            const lat = parseFloat(document.getElementById('force-lat').textContent);
            const lng = parseFloat(document.getElementById('force-lng').textContent);
            if (!name || isNaN(lat)) return alert("×—×¡×¨×™× ×¤×¨×˜×™×");

            fetch(SERVER_URL + '/api/forces/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: 'm_'+Date.now(), latitude: lat, longitude: lng, name, type: document.getElementById('force-type-input').value })
            }).then(() => closeAddForceModal());
        }

        // --- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ (×—×™×–×•×™, ×–×™×”×•×™ ××™×§×•× ×•×›×•') ---
        function updateLocationName(lat, lng) {
            // ×¡×™××•×œ×¦×™×” ×©×œ Reverse Geocoding ×¤×©×•×˜ ×›×“×™ ×œ× ×œ×”×¢××™×¡
            document.getElementById('location-name').textContent = `× .×¦. ${lat.toFixed(2)}, ${lng.toFixed(2)}`;
        }

        function openAddForceModal() { document.getElementById('add-force-modal').classList.add('active'); }
        function closeAddForceModal() { document.getElementById('add-force-modal').classList.remove('active'); }
        function openAddDeadZoneModal() { document.getElementById('add-deadzone-modal').classList.add('active'); }
        function closeAddDeadZoneModal() { document.getElementById('add-deadzone-modal').classList.remove('active'); }

        window.onload = initMap;
    </script>
</body>
</html>